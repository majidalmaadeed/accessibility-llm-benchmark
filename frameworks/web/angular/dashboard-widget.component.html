<div class="dashboard-widget">
  <div class="widget-header">
    <h2>Analytics Dashboard</h2>
    <div class="header-actions">
      <button 
        (click)="handleExport('csv')"
        [disabled]="isExporting"
        class="export-btn"
      >
        {{ isExporting ? 'Exporting...' : 'Export CSV' }}
      </button>
      <button 
        (click)="handleExport('pdf')"
        [disabled]="isExporting"
        class="export-btn"
      >
        {{ isExporting ? 'Exporting...' : 'Export PDF' }}
      </button>
    </div>
  </div>

  <div class="widget-filters">
    <div class="filter-group">
      <label>Time Range</label>
      <select [(ngModel)]="filters.timeRange" (change)="onTimeRangeChange()">
        <option value="7d">Last 7 Days</option>
        <option value="30d">Last 30 Days</option>
        <option value="90d">Last 90 Days</option>
      </select>
    </div>

    <div class="filter-group">
      <label>Region</label>
      <select [(ngModel)]="filters.region">
        <option value="all">All Regions</option>
        <option value="north">North America</option>
        <option value="europe">Europe</option>
        <option value="asia">Asia Pacific</option>
      </select>
    </div>
  </div>

  <div class="chart-section">
    <div class="chart-header">
      <h3>{{ getMetricLabel() }} Over Time</h3>
      <div class="chart-stats">
        <div class="stat">
          <span class="stat-label">Current</span>
          <span class="stat-value">
            {{ formatValue(getCurrentValue()) }}
          </span>
        </div>
        <div class="stat">
          <span class="stat-label">Average</span>
          <span class="stat-value">
            {{ formatValue(getAverageValue()) }}
          </span>
        </div>
        <div class="stat">
          <span class="stat-label">Peak</span>
          <span class="stat-value">
            {{ formatValue(getMaxValue()) }}
          </span>
        </div>
      </div>
    </div>

    <div class="chart-container">
      <svg width="600" height="300" class="chart-svg">
        <!-- Grid lines -->
        <g *ngFor="let ratio of [0, 0.25, 0.5, 0.75, 1]; let i = index">
          <line
            [attr.x1]="40"
            [attr.y1]="40 + ratio * 220"
            [attr.x2]="560"
            [attr.y2]="40 + ratio * 220"
            stroke="#e0e0e0"
            stroke-width="1"
          />
          <text
            [attr.x]="30"
            [attr.y]="40 + ratio * 220 + 5"
            text-anchor="end"
            font-size="12"
            fill="#666"
          >
            {{ Math.round(getMaxValue() * (1 - ratio)).toLocaleString() }}
          </text>
        </g>

        <!-- Data line -->
        <polyline
          fill="none"
          [attr.stroke]="getMetricColor()"
          stroke-width="3"
          [attr.points]="getDataLinePoints()"
        />

        <!-- Data points -->
        <circle
          *ngFor="let d of getCurrentMetric(); let index = index"
          [attr.cx]="40 + (index / (getCurrentMetric().length - 1)) * 520"
          [attr.cy]="40 + (1 - d.value / getMaxValue()) * 220"
          r="4"
          [attr.fill]="getMetricColor()"
          class="data-point"
          (mouseenter)="handleDataPointHover($event, d)"
          (mouseleave)="handleDataPointLeave()"
        />

        <!-- X-axis labels -->
        <text
          *ngFor="let d of getCurrentMetric(); let index = index"
          [attr.x]="40 + (index / (getCurrentMetric().length - 1)) * 520"
          y="280"
          text-anchor="middle"
          font-size="12"
          fill="#666"
          *ngIf="shouldShowLabel(index)"
        >
          {{ formatDate(d.date) }}
        </text>
      </svg>
    </div>

    <div class="legend">
      <div 
        *ngFor="let metric of metrics"
        [class]="'legend-item ' + (filters.metric === metric.key ? 'active' : '')"
        (click)="filters.metric = metric.key"
      >
        <div 
          class="legend-color" 
          [style.background-color]="metric.color"
        ></div>
        <span>{{ metric.label }}</span>
      </div>
    </div>
  </div>

  <div 
    *ngIf="showTooltip && selectedDataPoint"
    class="tooltip"
    [style.left.px]="tooltipPosition.x + 10"
    [style.top.px]="tooltipPosition.y - 10"
  >
    <div class="tooltip-header">
      {{ formatDate(selectedDataPoint.date) }}
    </div>
    <div class="tooltip-content">
      <strong>{{ getMetricLabel() }}:</strong> {{ formatValue(selectedDataPoint.value) }}
    </div>
  </div>

  <div class="widget-footer">
    <div class="data-info">
      <span>Data updated: {{ new Date().toLocaleString() }}</span>
      <span>â€¢</span>
      <span>{{ chartData.length }} data points</span>
    </div>
    <div class="chart-controls">
      <button class="control-btn">Zoom In</button>
      <button class="control-btn">Zoom Out</button>
      <button class="control-btn">Reset View</button>
    </div>
  </div>
</div>
